<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        canvas {
            background-color: #f1f1f1;
            height: 98vh;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
        }

        * {
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>
<body onload="loadFile(['data.js', 'render.js', 'generate.js', 'inventory.js', 'motion.js', 'mob.js', 'map.js', 'inventoryrender.js'])">
    <script>var maxClicks, recipes, dropitem, defaultTile, placable, speed = 0.0625, count = 31, dropblocs = [], invIndex = -1, walkable, blocks = [], screenNum = 0, biomes = [], inventory = [], selectIndex = 0, xpos = 500, ypos = 500, height = 1000, width = 1000, blockimg, lastClick = { x: -1, y: -1 }, clickCount = 1, bImage = new Image(), cs = document.createElement("CANVAS"), map = [], mapview = [], playerHealth = 20, maxHealth = 20, regenCount = 0, dmgcount = 0, pagenum = 0, pages = 1, mobs = [], spawnx = 500, spawny = 500, deathX = -1000, deathY = -1000;
        bImage.src = 'imgs/index wp.png';
        function startGame() {
            for (var i = 0; i < height; i++) {
                blocks[i] = [];
            }
            recipes = data.recipes;
            maxClicks = data.maxClicks;
            defaultTile = data.defaultTile;
            walkable = data.walkable;
            dropitem = data.dropitem;
            placable = data.placable;
            blockimg = data.blockimg;
            myGameArea.start();
            myGameArea.context.imageSmoothingEnabled = false;
            for (var x = 0; x < 30; x++) {
                inventory.push(['e', '']);
            }
        }
        var myGameArea = {
            keys: [],
            getc: function () {
                return blocks[Math.floor(ypos + this.y / 100 - 3)][Math.floor(xpos + this.x / 100 - 3)];
            },
            setc: function (e) {
                blocks[Math.floor(ypos + myGameArea.y / 100 - 3)][Math.floor(xpos + myGameArea.x / 100 - 3)] = e;
            },
            add: function (c, n) {
                if (n > 0) {
                    var ex = 0;
                    for (var k = 0; k < n; k++) {
                        var p = 0;
                        for (var x = 0; x < inventory.length; x++) {
                            if (inventory[x][0] == c && inventory[x][1] < (data.ms[inventory[x][0]] ?? 64)) {
                                inventory[x][1] += 1;
                                p = 1;
                                break;
                            }
                        }
                        var q = 0;
                        if (p == 0) {
                            for (var w = 0; w < inventory.length; w++) {
                                if (inventory[w][1] === '') {
                                    inventory[w][1] = 1;
                                    inventory[w][0] = c;
                                    q = 1;
                                    break;
                                }
                            }
                        }
                        if (q == 0 && p == 0) {
                            ex++;
                        }
                    }
                    if (ex > 0) {
                        dropblocs.push({
                            xp: xpos,
                            yp: ypos,
                            item: c,
                            num: ex
                        });
                    }
                } else if (n < 0) {
                    if (inventory[selectIndex][0] == c) {
                        inventory[selectIndex][1] += n;
                    } else {
                        for (var k = 0; k < Math.abs(n); k++) {
                            for (var x = inventory.length - 1; x >= 0; x--) {
                                if (inventory[x][0] == c) {
                                    inventory[x][1] -= 1;
                                    break;
                                }
                            }
                            clearBlanks();
                        }
                    }
                }
            },
            start: function () {
                document.getElementById("canvas").width = 700;
                document.getElementById("canvas").height = 700;
                this.context = document.getElementById("canvas").getContext("2d");
                imgp.src = 'imgs/player.png';
                imgp.onload = function () {
                    setInterval(updateGameArea, 20);
                };
                window.addEventListener('keydown', function (e) {
                    myGameArea.keys = (myGameArea.keys || []);
                    myGameArea.keys[e.keyCode] = (e.type == "keydown");
                });
                window.addEventListener('keyup', function (e) {
                    myGameArea.keys[e.keyCode] = (e.type == "keydown");
                });
                window.addEventListener('mousedown', function (e) {
                    myGameArea.x = e.clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.y = e.clientY * 70000 / (98 * window.innerHeight);
                    myGameArea.ax = e.clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.ay = e.clientY * 70000 / (98 * window.innerHeight);
                    myGameArea.click = true;
                });
                window.addEventListener('mousemove', function (e) {
                    myGameArea.x = e.clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.y = e.clientY * 70000 / (98 * window.innerHeight);
                    myGameArea.ax = e.clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.ay = e.clientY * 70000 / (98 * window.innerHeight);
                });
                window.addEventListener('mouseup', function (e) {
                    myGameArea.x = false;
                    myGameArea.y = false;
                    myGameArea.click = false;
                });
                window.addEventListener('touchstart', function (e) {
                    myGameArea.x = e.clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.y = e.clientY * 70000 / (98 * window.innerHeight);
                });
                window.addEventListener('touchmove', function (e) {
                    myGameArea.x = e.touches[0].clientX * 70000 / (98 * window.innerHeight);
                    myGameArea.y = e.touches[0].clientY * 70000 / (98 * window.innerHeight);
                });
                window.addEventListener('touchend', function (e) {
                    myGameArea.x = false;
                    myGameArea.y = false;
                });
            },
            clear: function () {
                this.context.clearRect(0, 0, document.getElementById("canvas").width, document.getElementById("canvas").height);
            }
        };
        function loadFile(src) {
            for (var q = 0; q < src.length; q++) {
                var script = document.createElement('SCRIPT');
                script.src = 'src/' + src[q];
                document.body.appendChild(script);
                if (q == src.length - 1) {
                    script.onload = () => {
                        startGame();
                    }
                }
            }
        }
        function updateGameArea() {
            myGameArea.clear();
            if (screenNum == 0) {
                myGameArea.context.drawImage(bImage, 0, 0, 700, 700);
                if (myGameArea.x && myGameArea.y && myGameArea.x > 286 && myGameArea.y > 286 && myGameArea.x < 413 && myGameArea.y < 413 && myGameArea.click) {
                    loadTiles();
                    spawnx = Math.floor(Math.random() * 990) + 5;
                    spawny = Math.floor(Math.random() * 990) + 5;
                    while (blocks[spawny][spawnx] != 'g') {
                        spawnx = Math.floor(Math.random() * 990) + 5;
                        spawny = Math.floor(Math.random() * 990) + 5;
                    }
                    xpos = spawnx;
                    ypos = spawny;
                    loadMap();
                    screenNum = 1;
                }
            } else if (screenNum == 1) {
                clearBlanks();
                renderBlocks();
                interact();
                renderDrops();
                renderPlayer(move());
                renMobs();
                renderHotbar();
                renderHealth();
                slotSwitch();
                updateMap();
                openMap();
                throwItems();
                if (myGameArea.keys && (myGameArea.keys[69] || myGameArea.keys[101])) {
                    screenNum = 2;
                    myGameArea.keys[101] = false;
                    myGameArea.keys[69] = false;
                }
            } else if (screenNum == 2) {
                myGameArea.context.fillStyle = '#000066';
                myGameArea.context.fillRect(0, 0, 700, 700);
                closeInventory();
                renderItems();
                clearBlanks();
                renderTrash();
                renderHoverItem();
                dealWithSwaps();
                renderPages();
                renderHoverCraft(dealWithCrafts(renderRecipes()));
            } else if (screenNum == 3) {
                renderMap();
                closeMap();
            } else if (screenNum == 4) {
                renderDeath();
            }
        }
    </script>
    <canvas id="canvas"></canvas>
</body>
</html>